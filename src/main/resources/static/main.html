<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íƒì‹œ ì¹´í’€ ì•± (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
<div id="root" class="min-h-screen flex items-center justify-center p-4"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // âš ï¸ Google Maps API í‚¤ (ë³¸ì¸ í‚¤ë¡œ êµì²´ í•„ìˆ˜)
    const GOOGLE_MAPS_API_KEY = "YOUR_API_KEY_HERE"; 
    
    // ë°±ì—”ë“œ ì£¼ì†Œ
    const API_BASE_URL = "http://localhost:8080";

    // --- [1] ë°±ì—”ë“œ API (ë¡œê·¸ì¸ & íšŒì›ê°€ì…) ---
    const api = {
        login: async (username, password) => {
            const res = await fetch(`${API_BASE_URL}/api/users/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });
            if (!res.ok) {
                // ì—ëŸ¬ ë©”ì‹œì§€ íŒŒì‹±
                const text = await res.text();
                throw new Error(text || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
            }
            return await res.json();
        },
        signup: async (username, password) => {
            const res = await fetch(`${API_BASE_URL}/api/users/signup`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            });
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || "íšŒì›ê°€ì… ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
            }
            return await res.json();
        }
    };

    // --- [2] ë©”ì¸ ì•± ì»´í¬ë„ŒíŠ¸ ---
    function App() {
        const [page, setPage] = useState('auth'); // auth(ë¡œê·¸ì¸/ê°€ì…), home, matched
        const [user, setUser] = useState(null);
        const [matchInfo, setMatchInfo] = useState(null);
        const [status, setStatus] = useState("IDLE"); 
        
        const stompClient = useRef(null);
        const mapRef = useRef(null);
        const startInputRef = useRef(null);
        const endInputRef = useRef(null);

        // ì¢Œí‘œ ìƒíƒœ
        const [startLoc, setStartLoc] = useState({ lat: 37.4979, lng: 127.0276, addr: "ê°•ë‚¨ì—­" });
        const [endLoc, setEndLoc] = useState({ lat: 37.3947, lng: 127.1111, addr: "íŒêµì—­" });


        // [A] ë¡œê·¸ì¸ ì„±ê³µ í›„ ë¡œì§
        useEffect(() => {
            if (page === 'home' && user) {
                connectWebSocket();
                initGoogleMap();
            }
            return () => { if (stompClient.current) stompClient.current.disconnect(); };
        }, [page, user]);


        // [B] WebSocket ì—°ê²°
        const connectWebSocket = () => {
            const socket = new SockJS(`${API_BASE_URL}/ws`);
            const client = Stomp.over(socket);
            client.debug = () => {}; 

            client.connect({}, () => {
                console.log("âœ… WebSocket ì—°ê²°ë¨");
                client.subscribe(`/topic/match/${user.username}`, (msg) => {
                    const data = JSON.parse(msg.body);
                    setMatchInfo(data);
                    setStatus("MATCHED");
                    setPage("matched");
                });
            }, (err) => console.error(err));
            stompClient.current = client;
        };


        // [C] ì§€ë„ ì´ˆê¸°í™”
        const initGoogleMap = () => {
            if (!window.google || !window.google.maps) return;
            const map = new google.maps.Map(mapRef.current, {
                center: { lat: startLoc.lat, lng: startLoc.lng },
                zoom: 13,
                disableDefaultUI: true,
            });
            const setupAutocomplete = (inputRef, setLocFunc) => {
                const autocomplete = new google.maps.places.Autocomplete(inputRef.current);
                autocomplete.bindTo('bounds', map);
                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (!place.geometry) return;
                    setLocFunc({ 
                        lat: place.geometry.location.lat(), 
                        lng: place.geometry.location.lng(),
                        addr: place.formatted_address 
                    });
                    if (place.geometry.viewport) map.fitBounds(place.geometry.viewport);
                    else map.setCenter(place.geometry.location);
                });
            };
            setupAutocomplete(startInputRef, setStartLoc);
            setupAutocomplete(endInputRef, setEndLoc);
        };


        // [D] ì¹´í’€ ìš”ì²­
        const handleRideRequest = (e) => {
            e.preventDefault();
            if (!stompClient.current) return;
            const requestDto = {
                username: user.username,
                startLat: startLoc.lat,
                startLng: startLoc.lng,
                startAddress: startInputRef.current.value || startLoc.addr,
                endLat: endLoc.lat,
                endLng: endLoc.lng,
                endAddress: endInputRef.current.value || endLoc.addr
            };
            stompClient.current.send("/app/match/request", {}, JSON.stringify(requestDto));
            setStatus("WAITING");
        };

        const handleCancel = () => {
            if (stompClient.current) stompClient.current.send("/app/match/cancel", {}, JSON.stringify({ username: user.username }));
            setStatus("IDLE");
        };

        // --- ë Œë”ë§ ---
        
        // 1. ì¸ì¦(ë¡œê·¸ì¸/íšŒì›ê°€ì…) í˜ì´ì§€
        if (page === 'auth') {
            return <AuthPage onLoginSuccess={(u) => { setUser(u); setPage('home'); }} />;
        }

        // 2. ë©”ì¸ í˜ì´ì§€
        if (page === 'home') {
            return (
                <div className="bg-white w-full max-w-md p-6 rounded-3xl shadow-xl fade-in relative">
                    <h2 className="text-xl font-bold mb-4">ğŸš– ì–´ë””ë¡œ ê°ˆê¹Œìš”?</h2>
                    <div ref={mapRef} className="w-full h-48 bg-slate-200 rounded-xl mb-4 text-center flex items-center justify-center text-slate-500 text-sm">
                        {(!window.google) ? "Google Maps API í‚¤ í™•ì¸ í•„ìš”" : "ì§€ë„ ë¡œë”© ì¤‘..."}
                    </div>

                    {status === "IDLE" ? (
                        <form onSubmit={handleRideRequest} className="space-y-3">
                            <div><label className="text-xs font-bold text-slate-500 ml-1">ì¶œë°œì§€</label><input ref={startInputRef} className="w-full p-3 border rounded-lg" defaultValue="ê°•ë‚¨ì—­" /></div>
                            <div><label className="text-xs font-bold text-slate-500 ml-1">ë„ì°©ì§€</label><input ref={endInputRef} className="w-full p-3 border rounded-lg" defaultValue="íŒêµì—­" /></div>
                            <button className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700">ì¹´í’€ ë§¤ì¹­ ì‹œì‘</button>
                        </form>
                    ) : (
                        <div className="text-center py-8 bg-blue-50 rounded-xl border border-blue-100">
                            <div className="animate-spin text-3xl mb-3">ğŸ”„</div>
                            <h3 className="font-bold text-blue-900">ë§¤ì¹­ ì¤‘ì…ë‹ˆë‹¤...</h3>
                            <button onClick={handleCancel} className="mt-4 px-4 py-2 bg-white border text-slate-600 rounded-full text-sm">ìš”ì²­ ì·¨ì†Œ</button>
                        </div>
                    )}
                </div>
            );
        }

        // 3. ë§¤ì¹­ ì„±ê³µ í˜ì´ì§€
        if (page === 'matched' && matchInfo) {
            return (
                <div className="bg-white w-full max-w-md p-6 rounded-3xl shadow-xl fade-in text-center">
                    <div className="text-5xl mb-4">ğŸ‰</div>
                    <h2 className="text-2xl font-bold text-green-600 mb-2">ë§¤ì¹­ ì„±ê³µ!</h2>
                    <div className="bg-slate-50 p-4 rounded-xl text-left space-y-2 mb-6 border">
                        <p>ğŸ‘¤ <b>ìƒëŒ€ë°©:</b> {matchInfo.opponentUsername}</p>
                        <p>ğŸ“¢ <b>íƒ€ì…:</b> {matchInfo.type === "GOTO" ? "ì´ë™í•˜ì„¸ìš”" : "ê¸°ë‹¤ë¦¬ì„¸ìš”"}</p>
                    </div>
                    <button onClick={() => { setStatus("IDLE"); setPage("home"); setMatchInfo(null); }} className="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700">í™•ì¸</button>
                </div>
            );
        }
        return <div>Error</div>;
    }

    // --- [3] ì¸ì¦(ë¡œê·¸ì¸/íšŒì›ê°€ì…) UI ì»´í¬ë„ŒíŠ¸ ---
    function AuthPage({ onLoginSuccess }) {
        const [isLogin, setIsLogin] = useState(true); // true: ë¡œê·¸ì¸, false: íšŒì›ê°€ì…
        const [username, setUsername] = useState("");
        const [password, setPassword] = useState("");
        const [isLoading, setIsLoading] = useState(false);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setIsLoading(true);
            try {
                if (isLogin) {
                    // ë¡œê·¸ì¸ ì‹œë„
                    const user = await api.login(username, password);
                    onLoginSuccess(user);
                } else {
                    // íšŒì›ê°€ì… ì‹œë„
                    await api.signup(username, password);
                    alert("ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    setIsLogin(true); // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
                }
            } catch (err) {
                alert(err.message);
            } finally {
                setIsLoading(false);
            }
        };

        return (
            <div className="bg-white w-full max-w-sm p-6 rounded-3xl shadow-xl fade-in">
                <h1 className="text-2xl font-bold text-center mb-6">ğŸš– íƒì‹œ ì¹´í’€</h1>
                
                {/* íƒ­ ë²„íŠ¼ */}
                <div className="flex bg-slate-100 p-1 rounded-xl mb-6">
                    <button onClick={() => setIsLogin(true)} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${isLogin ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>ë¡œê·¸ì¸</button>
                    <button onClick={() => setIsLogin(false)} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${!isLogin ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>íšŒì›ê°€ì…</button>
                </div>

                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-xs font-bold text-slate-500 mb-1">ì•„ì´ë””</label>
                        <input className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                               type="text" value={username} onChange={e=>setUsername(e.target.value)} placeholder="ì•„ì´ë”” ì…ë ¥" required />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-slate-500 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                        <input className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                               type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required />
                    </div>

                    {!isLogin && (
                        <div className="p-3 bg-yellow-50 text-xs text-yellow-700 rounded-lg">
                            * í˜„ì¬ ë°±ì—”ë“œ ì„¤ì •ìƒ <b>ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸</b>ë§Œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
                        </div>
                    )}

                    <button disabled={isLoading} className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 disabled:bg-slate-300 transition">
                        {isLoading ? "ì²˜ë¦¬ ì¤‘..." : (isLogin ? "ë¡œê·¸ì¸" : "íšŒì›ê°€ì…")}
                    </button>
                </form>
            </div>
        );
    }

    // Google Maps Script Loader
    if (GOOGLE_MAPS_API_KEY !== "YOUR_API_KEY_HERE") {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places`;
        script.async = true;
        document.head.appendChild(script);
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>